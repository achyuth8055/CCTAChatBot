<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management | Khatib Law Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
        }

        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-lg);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-page);
            color: var(--text-primary);
        }

        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue { background: #dbeafe; color: var(--primary); }
        .stat-icon.green { background: #dcfce7; color: var(--success); }
        .stat-icon.amber { background: #fef3c7; color: var(--warning); }

        .stat-info h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        
        .doc-table {
            width: 100%;
            border-collapse: collapse;
        }

        .doc-table th {
            text-align: left;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .doc-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .doc-table tr:last-child td {
            border-bottom: none;
        }

        .doc-table tr:hover {
            background: #f8fafc;
        }

        .doc-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .doc-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .doc-info h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .doc-info p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-trained { background: #dcfce7; color: #166534; }
        .status-processing { background: #fef3c7; color: #92400e; }
        .status-pending { background: #e0e7ff; color: #3730a3; }
        .status-failed { background: #fee2e2; color: #991b1b; }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: currentColor;
        }

        .status-processing .status-dot {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        
        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 2.25rem;
            height: 2.25rem;
            border: none;
            border-radius: 0.5rem;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            background: var(--bg-page);
            color: var(--text-primary);
        }

        .icon-btn.danger:hover {
            background: #fee2e2;
            color: var(--danger);
        }

        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            margin-bottom: 1.5rem;
        }

        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 480px;
            overflow: hidden;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .dropzone:hover,
        .dropzone.dragover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .dropzone i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .dropzone h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .dropzone p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .dropzone input {
            display: none;
        }

        .selected-file {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .selected-file i {
            color: var(--danger);
        }

        .selected-file span {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .selected-file button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        
        .upload-progress {
            margin-top: 1rem;
        }

        .progress-bar {
            height: 0.5rem;
            background: var(--border);
            border-radius: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 1rem;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        
        .delete-icon {
            width: 4rem;
            height: 4rem;
            background: #fee2e2;
            color: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
        }

        .delete-modal-body {
            text-align: center;
        }

        .delete-modal-body h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .delete-modal-body p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        .delete-warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #92400e;
            text-align: left;
        }

        
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            max-width: 360px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success .toast-icon { background: #dcfce7; color: var(--success); }
        .toast.error .toast-icon { background: #fee2e2; color: var(--danger); }
        .toast.info .toast-icon { background: #dbeafe; color: var(--primary); }

        .toast-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .toast-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .main-content {
                padding: 1rem;
            }

            .doc-table th:nth-child(3),
            .doc-table td:nth-child(3),
            .doc-table th:nth-child(4),
            .doc-table td:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    
    <header class="header">
        <h1>
            <i class="fas fa-folder-open"></i>
            Document Management
        </h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/'">
                <i class="fas fa-comments"></i>
                Chat
            </button>
            <button class="btn btn-primary" onclick="openUploadModal()">
                <i class="fas fa-plus"></i>
                Upload PDF
            </button>
        </div>
    </header>

    
    <main class="main-content">
        
        <div id="orphanedWarning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <i class="fas fa-exclamation-triangle" style="color: #ff9800; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #856404;">Legacy Embeddings Detected</h4>
                    <p style="margin: 0 0 0.5rem 0; color: #856404;">
                        Found <strong id="orphanedCount">0</strong> embeddings from old training data that cannot be individually deleted. 
                        These were created without proper document tracking metadata.
                    </p>
                    <p style="margin: 0; color: #856404;">
                        <strong>Solution:</strong> Use the "Reset All" button below to completely clear the database and start fresh.
                    </p>
                </div>
            </div>
        </div>

        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalDocs">0</h3>
                    <p>Total Documents</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="trainedDocs">0</h3>
                    <p>Trained</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon amber">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalEmbeddings">0</h3>
                    <p>Embeddings</p>
                </div>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <h2>
                    <i class="fas fa-list"></i>
                    Documents
                </h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-danger" onclick="openResetModal()" title="Delete everything">
                        <i class="fas fa-trash"></i>
                        Reset All
                    </button>
                    <button class="btn btn-ghost" onclick="refreshDocuments()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div id="documentList">
                
            </div>
        </div>
    </main>

    
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Reset Everything</h3>
                <button class="modal-close" onclick="closeResetModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body delete-modal-body">
                <div class="delete-icon" style="background: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4>üö® DANGER: Nuclear Option</h4>
                <p><strong>This will delete EVERYTHING permanently:</strong></p>
                <div class="delete-warning" style="background: #fee; border-color: #dc3545;">
                    <ul style="text-align: left; margin: 0.5em 0;">
                        <li>‚úó ALL PDF files</li>
                        <li>‚úó ALL 48 embeddings</li>
                        <li>‚úó ALL database records</li>
                        <li>‚úó Complete chatbot knowledge</li>
                    </ul>
                </div>
                <div class="delete-warning" style="background: #000; color: #fff; border-color: #dc3545; margin-top: 1em;">
                    <i class="fas fa-skull-crossbones"></i>
                    <strong>THIS CANNOT BE UNDONE!</strong>
                </div>
                <p style="margin-top: 1em; color: #666;">Type <strong>DELETE ALL</strong> to confirm:</p>
                <input type="text" id="resetConfirmInput" placeholder="DELETE ALL" 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #dc3545; border-radius: 0.5rem; font-size: 1rem; text-align: center;"
                       oninput="checkResetConfirm()">
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeResetModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmResetBtn" onclick="confirmReset()" disabled>
                    <i class="fas fa-trash-alt"></i>
                    Delete Everything
                </button>
            </div>
        </div>
    </div>

    
    <div class="modal-overlay" id="uploadModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Upload PDF Document</h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="dropzone" id="dropzone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Drop your PDF here</h4>
                    <p>or click to browse (max 10 MB)</p>
                    <input type="file" id="fileInput" accept=".pdf,application/pdf">
                </div>
                <div id="selectedFile" class="selected-file" style="display: none;">
                    <i class="fas fa-file-pdf"></i>
                    <span id="selectedFileName">document.pdf</span>
                    <button onclick="clearSelectedFile()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p class="progress-text" id="progressText">Uploading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadDocument()" disabled>
                    <i class="fas fa-upload"></i>
                    Upload
                </button>
            </div>
        </div>
    </div>

    
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Document</h3>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body delete-modal-body">
                <div class="delete-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h4>‚ö†Ô∏è Warning: Permanent Deletion</h4>
                <p>You are about to permanently delete <strong id="deleteFileName">document.pdf</strong></p>
                <div class="delete-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>All data will be lost forever:</strong>
                    <ul style="text-align: left; margin-top: 0.5em;">
                        <li>‚úó Original PDF file</li>
                        <li>‚úó All trained embeddings</li>
                        <li>‚úó Database records</li>
                    </ul>
                </div>
                <div class="delete-warning" style="background: #fee; border-color: #dc3545; margin-top: 1em;">
                    <i class="fas fa-ban"></i>
                    <strong>Cannot be undone!</strong> The chatbot will no longer answer questions from this document.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash-alt"></i>
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>

    
    <div class="toast-container" id="toastContainer"></div>

    <script>

        const CHATBOT_ID = 'default';
        const API_BASE = '/api';
        
        let selectedFile = null;
        let deleteDocumentId = null;

        document.addEventListener('DOMContentLoaded', () => {
            refreshDocuments();
            refreshStats();
            setupDropzone();
            
            setInterval(() => {
                refreshDocuments();
                refreshStats();
            }, 3000);
        });

        async function fetchDocuments() {
            try {
                const res = await fetch(`${API_BASE}/chatbots/${CHATBOT_ID}/documents`);
                const data = await res.json();
                return data.documents || [];
            } catch (err) {
                console.error('Error fetching documents:', err);
                showToast('error', 'Error', 'Failed to load documents');
                return [];
            }
        }

        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/documents/stats`);
                return await res.json();
            } catch (err) {
                console.error('Error fetching stats:', err);
                return {};
            }
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch(`${API_BASE}/chatbots/${CHATBOT_ID}/documents`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Upload failed');
            }

            return await res.json();
        }

        async function deleteDocument(docId) {
            const res = await fetch(`${API_BASE}/documents/${docId}`, {
                method: 'DELETE'
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Delete failed');
            }

            return await res.json();
        }

        async function retrainDocument(docId) {
            const res = await fetch(`${API_BASE}/documents/${docId}/train`, {
                method: 'POST'
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Retrain failed');
            }

            return await res.json();
        }

        async function refreshDocuments() {
            const documents = await fetchDocuments();
            renderDocumentList(documents);
        }

        async function refreshStats() {
            const stats = await fetchStats();
            document.getElementById('totalDocs').textContent = stats.total_documents || 0;
            document.getElementById('trainedDocs').textContent = stats.trained_documents || 0;
            document.getElementById('totalEmbeddings').textContent = stats.total_embeddings || 0;
            
            const orphanedCount = stats.orphaned_embeddings || 0;
            const warningBanner = document.getElementById('orphanedWarning');
            if (orphanedCount > 0 && warningBanner) {
                warningBanner.style.display = 'block';
                document.getElementById('orphanedCount').textContent = orphanedCount;
            } else if (warningBanner) {
                warningBanner.style.display = 'none';
            }
        }

        function renderDocumentList(documents) {
            const container = document.getElementById('documentList');

            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-pdf"></i>
                        <h3>No documents yet</h3>
                        <p>Upload a PDF to start training your chatbot</p>
                        <button class="btn btn-primary" onclick="openUploadModal()">
                            <i class="fas fa-plus"></i>
                            Upload PDF
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th>Document</th>
                            <th>Status</th>
                            <th>Chunks</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const doc of documents) {
                const statusBadge = getStatusBadge(doc.status);
                const timeAgo = formatTimeAgo(doc.created_at);
                
                html += `
                    <tr>
                        <td>
                            <div class="doc-name">
                                <div class="doc-icon">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div class="doc-info">
                                    <h4>${escapeHtml(doc.filename)}</h4>
                                    <p>${formatFileSize(doc.file_size)}</p>
                                </div>
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${doc.chunk_count || '-'}</td>
                        <td>${timeAgo}</td>
                        <td>
                            <div class="actions">
                                <button class="icon-btn" onclick="downloadDoc('${doc.id}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="icon-btn" onclick="retrain('${doc.id}')" title="Retrain">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="icon-btn danger" onclick="openDeleteModal('${doc.id}', '${escapeHtml(doc.filename)}')" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function getStatusBadge(status) {
            const badges = {
                'trained': '<span class="status-badge status-trained"><span class="status-dot"></span>Trained</span>',
                'processing': '<span class="status-badge status-processing"><span class="status-dot"></span>Processing</span>',
                'pending': '<span class="status-badge status-pending"><span class="status-dot"></span>Pending</span>',
                'failed': '<span class="status-badge status-failed"><span class="status-dot"></span>Failed</span>',
                'deleting': '<span class="status-badge status-failed"><span class="status-dot"></span>Deleting</span>'
            };
            return badges[status] || status;
        }

        function openUploadModal() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFile').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
        }

        function setupDropzone() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            dropzone.addEventListener('click', () => fileInput.click());

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                showToast('error', 'Invalid file', 'Please select a PDF file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showToast('error', 'File too large', 'Maximum file size is 10 MB');
                return;
            }

            selectedFile = file;
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFile').style.display = 'flex';
            document.getElementById('uploadBtn').disabled = false;
        }

        function clearSelectedFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFile').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
        }

        async function uploadDocument() {
            if (!selectedFile) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Uploading...';

            try {
                progressFill.style.width = '30%';
                progressText.textContent = 'Uploading file...';

                await uploadFile(selectedFile);
                
                progressFill.style.width = '100%';
                progressText.textContent = 'Upload complete!';

                showToast('success', 'Uploaded', `${selectedFile.name} is now training`);
                
                setTimeout(() => {
                    closeUploadModal();
                    refreshDocuments();
                    refreshStats();
                }, 1000);

            } catch (err) {
                showToast('error', 'Upload failed', err.message);
                uploadBtn.disabled = false;
                progressDiv.style.display = 'none';
            }
        }

        function openDeleteModal(docId, filename) {
            deleteDocumentId = docId;
            document.getElementById('deleteFileName').textContent = filename;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteDocumentId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteDocumentId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

            try {
                await deleteDocument(deleteDocumentId);
                showToast('success', 'Deleted', 'Document removed successfully');
                closeDeleteModal();
                refreshDocuments();
                refreshStats();
            } catch (err) {
                showToast('error', 'Delete failed', err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Permanently';
            }
        }

        function openResetModal() {
            document.getElementById('resetModal').classList.add('active');
            document.getElementById('resetConfirmInput').value = '';
            document.getElementById('confirmResetBtn').disabled = true;
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }

        function checkResetConfirm() {
            const input = document.getElementById('resetConfirmInput');
            const btn = document.getElementById('confirmResetBtn');
            btn.disabled = input.value !== 'DELETE ALL';
        }

        async function confirmReset() {
            const btn = document.getElementById('confirmResetBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting Everything...';

            try {
                const res = await fetch(`${API_BASE}/documents/reset-all`, {
                    method: 'POST'
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Reset failed');
                }

                const result = await res.json();
                showToast('success', 'Reset Complete', 
                    `Deleted ${result.deleted_documents} documents and ${result.deleted_embeddings} embeddings`);
                
                closeResetModal();
                refreshDocuments();
                refreshStats();
            } catch (err) {
                showToast('error', 'Reset failed', err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Everything';
            }
        }

        function openDeleteModal(docId, filename) {
            deleteDocumentId = docId;
            document.getElementById('deleteFileName').textContent = filename;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteDocumentId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteDocumentId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

            try {
                await deleteDocument(deleteDocumentId);
                showToast('success', 'Deleted', 'Document removed successfully');
                closeDeleteModal();
                refreshDocuments();
                refreshStats();
            } catch (err) {
                showToast('error', 'Delete failed', err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Permanently';
            }
        }

        function downloadDoc(docId) {
            window.open(`${API_BASE}/documents/${docId}/download`, '_blank');
        }

        async function retrain(docId) {
            try {
                await retrainDocument(docId);
                showToast('info', 'Retraining', 'Document is being reprocessed');
                refreshDocuments();
            } catch (err) {
                showToast('error', 'Retrain failed', err.message);
            }
        }

        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            
            const icons = {
                success: 'fa-check',
                error: 'fa-times',
                info: 'fa-info'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type] || 'fa-info'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return '-';
            
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hr ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>
